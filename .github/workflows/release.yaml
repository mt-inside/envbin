name: release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  container:
    name: Build and publish container image
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Make GH release
        id: make_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: ${{ github.ref }} # Guarenteed to be a tag cause by definion we're on one
          release_name: Release ${{ github.ref }}
          prerelease: false
          draft: true

      - name: Build APK
        id: melange
        uses: chainguard-dev/actions/melange-build@main
        with:
          config: melange.yaml
          archs: x86_64,aarch64
          sign-with-temporary-key: true

      - name: Build & Publish OCI
        id: apko
        # GH: chainguard-images/action/apko-publish
        uses: distroless/actions/apko-publish@main
        with:
          config: apko.yaml
          archs: x86_64,aarch64
          # Will be a SHA, unless this commit is tagged. Which is ideal tbh
          tag: ghcr.io/mt-inside/envbin:${{ github.ref_name }} ghcr.io/mt-inside/envbin:latest
          # Default value for melange-build.signing-key-path
          keyring-append: ${{ github.workspace }}/melange.rsa.pub

      # Need to install cosign. Also what keymat does it sign with?
      # - name: Sign OCI
      #   shell: bash
      #   run: COSIGN_EXPERIMENTAL=true cosign sign ${{ steps.apko.outputs.digest }}
